<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ktor SDUI ìŠ¤í¬ë¦°</title>
    <style>
        /* 5000px x 5000px í¬ê¸°ì˜ ê³ ì •ëœ ìº”ë²„ìŠ¤ */
        body {
            width: 5000px;
            height: 5000px;
            margin: 0;
            padding: 0;
            position: relative; /* ìì‹ ìš”ì†Œ(absolute)ì˜ ê¸°ì¤€ì  */
            overflow: hidden;
        }

        p, button {
            margin: 0;
        }

        .download-wrapper {
            position: fixed;
            top: 20px;
            right: -190px;
            z-index: 9999;
            padding-right: 20px;
            transition: right 0.3s ease-in-out;
        }
        .download-wrapper:hover {
            right: 0; /* í™”ë©´ ì˜¤ë¥¸ìª½ ëê¹Œì§€ ë¶™ìŒ */
        }

        #downloadBtn {
            display: block;
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            transition: background-color 0.2s ease-in-out;
        }
        #downloadBtn:hover {
            background-color: #0056b3;
        }

        .toast-message {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .toast-message.show {
            opacity: 0.95;
        }
    </style>
</head>
<body>

<div class="download-wrapper ui-control">
    <button id="downloadBtn">ğŸ“¥ HTML ë‹¤ìš´ë¡œë“œ</button>
</div>

<script>
    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
    document.getElementById('downloadBtn').addEventListener('click', () => {
        // 1) í˜„ì¬ ë¬¸ì„œì˜ ì „ì²´ êµ¬ì¡°(html íƒœê·¸ í¬í•¨)ë¥¼ ë³µì œ(Clone)í•©ë‹ˆë‹¤.
        const clone = document.documentElement.cloneNode(true);

        // 2) ë³µì œëœ ë¬¸ì„œì—ì„œ ë¶ˆí•„ìš”í•œ UI ìš”ì†Œ(ë²„íŠ¼, íƒ€ì´í‹€)ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
        const uiControls = clone.querySelectorAll('.ui-control');
        uiControls.forEach(el => el.remove());

        // 3) ë³µì œëœ ë¬¸ì„œì—ì„œ ìŠ¤í¬ë¦½íŠ¸(WebSocket ì—°ê²° ë¡œì§)ë¥¼
        const scripts = clone.querySelectorAll('script');
        scripts.forEach(el => el.remove());

        // 4) HTML ë¬¸ìì—´ë¡œ ë³€í™˜
        const htmlContent = `<!DOCTYPE html>\n` + clone.outerHTML;

        // 5) ê°€ìƒì˜ ë§í¬ë¥¼ ë§Œë“¤ì–´ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
        const blob = new Blob([htmlContent], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'my_website_result.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');

    if (!roomId) {
        document.body.innerHTML = "<h1>Error: ìº”ë²„ìŠ¤ ID(Room ID)ê°€ URLì— ì—†ìŠµë‹ˆë‹¤.</h1>";

    } else {
        // room IDê°€ í¬í•¨ëœ ì£¼ì†Œë¡œ ì›¹ì†Œì¼“ ì—°ê²°ì„ ìˆ˜í–‰
        const ws = new WebSocket(`ws://localhost:8080/ws/${roomId}`);

        function aarrggbbToRgba(hex) {
            hex = hex.replace('#', ''); // '#' ì œê±°

            // 6ìë¦¬ (RRGGBB)ê°€ ì˜¤ë©´, íˆ¬ëª…ë„ 100% (FF)ë¥¼ ë§¨ ì•ì— ì¶”ê°€
            if (hex.length === 6) {
                hex = 'FF' + hex;
            }

            // 8ìë¦¬ (AARRGGBB)ê°€ ì•„ë‹ˆë©´ ì˜¤ë¥˜
            if (hex.length !== 8) {
                console.warn("ì˜ëª»ëœ AARRGGBB í˜•ì‹:", hex);
                return null; // (ê¸°ë³¸ê°’)
            }

            const a = parseInt(hex.substring(0, 2), 16) / 255.0; // Alpha (íˆ¬ëª…ë„)
            const r = parseInt(hex.substring(2, 4), 16); // Red
            const g = parseInt(hex.substring(4, 6), 16); // Green
            const b = parseInt(hex.substring(6, 8), 16); // Blue

            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }


        function applyStylesAndText(el, command) {
            el.style.position = 'absolute';
            el.style.top = (command.offsetY || 10) + 'px';
            el.style.left = (command.offsetX || 10) + 'px';
            el.style.width = (command.width || 200) + 'px';
            el.style.height = (command.height || 150) + 'px';

            el.style.display = 'flex';
            el.style.alignItems = 'center'; // ìˆ˜ì§ ì¤‘ì•™
            el.style.justifyContent = 'center'; // ìˆ˜í‰ ì¤‘ì•™

            if (command.text) {
                el.innerText = command.text;
            }

            if (command.style) {
                const style = command.style;
                if (style.backgroundColor) el.style.backgroundColor = aarrggbbToRgba(style.backgroundColor);
                if (style.fontColor) el.style.color = aarrggbbToRgba(style.fontColor);
                if (style.fontSize) el.style.fontSize = style.fontSize + 'px';
                if (style.fontWeight) el.style.fontWeight = style.fontWeight;
                if (style.fontFamily) el.style.fontFamily = style.fontFamily;

                if (style.borderColor) {
                    el.style.borderColor = aarrggbbToRgba(style.borderColor);
                    el.style.borderWidth = '1px';
                    el.style.borderStyle = 'solid';
                }

                if (command.type !== "Image" && style.borderRadius) {
                    el.style.borderRadius = style.borderRadius + 'px';
                }
            }

            if (command.type === "Image" && command.imageUrl) {
                const imageUrl = getCorrectedWebImageUrl(command.imageUrl);

                // 1. ê¸°ì¡´ ìš”ì†Œì˜ ë‚´ìš©ì„ ëª¨ë‘ ì§€ì›ë‹ˆë‹¤.
                el.innerHTML = '';

                // 2. ì´ë¯¸ì§€ë¥¼ ë‹´ì„ HTML ìš”ì†Œ ìƒì„±
                const img = document.createElement('img');
                img.src = imageUrl; // ë³´ì •ëœ URL ì ìš©

                // 3. ì´ë¯¸ì§€ê°€ ë¶€ëª¨ divë¥¼ ê½‰ ì±„ìš°ë„ë¡ ìŠ¤íƒ€ì¼ ì„¤ì •
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover'; // ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ìš°ê¸°
                img.style.borderRadius = (command.style?.borderRadius || 0) + 'px'; // Border Radius ì ìš©

                // 4. ì»´í¬ë„ŒíŠ¸ ìš”ì†Œì— ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ì‚½ì…
                el.appendChild(img);

            } else if (command.type === "Button" && command.onClickAction) {
                el.addEventListener('click', () => {
                    // ì´ì „ì— ì •ì˜í•œ ì´ë²¤íŠ¸ í•´ì„ í•¨ìˆ˜ í˜¸ì¶œ (í† ìŠ¤íŠ¸ ë„ìš°ê¸°)
                    executeComponentAction(command.onClickAction);
                });
            } else if (command.text) {
                // Image íƒ€ì…ì´ ì•„ë‹ ë•Œë§Œ í…ìŠ¤íŠ¸ë¥¼ ë„£ìŠµë‹ˆë‹¤.
                el.innerHTML = command.text; // innerText ëŒ€ì‹  innerHTMLì„ ì‚¬ìš©í•˜ì—¬ ì´ì „ ì½˜í…ì¸  ì œê±° (ì„ íƒ ì‚¬í•­)
            }
        }

        ws.onopen = () => {
            console.log(`ì„œë²„ì™€ WebSocket ì—°ê²°ë¨. (Room: ${roomId})`);
        };

        function createComponentElement(command) {
            let el;
            if (command.type === "Text") el = document.createElement("p");
            else if (command.type === "Button") el = document.createElement("button");
            else el = document.createElement("div");
            el.id = command.id;
            return el;
        }

        ws.onmessage = (event) => {
            console.log("ì„œë²„ ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
            let commands = JSON.parse(event.data);

            if (Array.isArray(commands)) {
                // (ì´ˆê¸° ë°ì´í„° ë¡œë“œ)
                commands.forEach(command => {
                    const existingEl = document.getElementById(command.id);
                    if (existingEl) existingEl.remove();

                    let el = createComponentElement(command);
                    applyStylesAndText(el, command);
                    document.body.appendChild(el);
                });
            } else {
                // ì‹¤ì‹œê°„ ëª…ë ¹ ìˆ˜ì‹ 
                const command = commands;
                if (command.action === "Create" || command.action === "Update") {
                    let elToUpdate = document.getElementById(command.id);
                    if (elToUpdate) {
                        applyStylesAndText(elToUpdate, command);
                    } else {
                        elToUpdate = createComponentElement(command);
                        applyStylesAndText(elToUpdate, command);
                        document.body.appendChild(elToUpdate);
                    }
                } else if (command.action === "Delete") {
                    const elToRemove = document.getElementById(command.id);
                    if (elToRemove) elToRemove.remove();
                }
            }
        };
    }

    function executeComponentAction(action) {
        if (!action || !action.type) return;

        switch (action.type) {
            case "SHOW_TOAST":
                displayToast(action.message || "ë²„íŠ¼ì´ í´ë¦­ë˜ì—ˆìŠµë‹ˆë‹¤!", 3000);
                break;
            case "REDIRECT_URL":
                if (action.targetUrl) {
                    window.location.href = action.targetUrl;
                }
                break;
            default:
                console.error(`ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ íƒ€ì…: ${action.type}`);
        }
    }

    function displayToast(message, durationInMs = 3000) {
        const toastEl = document.createElement('div');
        toastEl.className = 'toast-message';
        toastEl.textContent = message;
        document.body.appendChild(toastEl);
        setTimeout(() => { toastEl.classList.add('show'); }, 10);
        setTimeout(() => {
            toastEl.classList.remove('show');
            setTimeout(() => { toastEl.remove(); }, 300);
        }, durationInMs);
    }

    function getCorrectedWebImageUrl(originalUrl) {
        const currentHost = window.location.protocol + "//" + window.location.host;
        return originalUrl.replace("http://localhost:8080", currentHost);
    }
</script>
</body>
</html>