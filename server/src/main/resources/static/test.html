<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ktor SDUI ìŠ¤í¬ë¦°</title>
    <style>
        /* 5000px x 5000px í¬ê¸°ì˜ ê³ ì •ëœ ìº”ë²„ìŠ¤ */
        body {
            width: 5000px;
            height: 5000px;
            margin: 0;
            padding: 0;
            position: relative; /* ìì‹ ìš”ì†Œ(absolute)ì˜ ê¸°ì¤€ì  */
            overflow: hidden;
        }

        p, button {
            margin: 0;
        }

        .download-wrapper {
            position: fixed;
            top: 20px;
            right: -190px;
            z-index: 9999;
            padding-right: 20px;
            transition: right 0.3s ease-in-out;
        }
        .download-wrapper:hover {
            right: 0; /* í™”ë©´ ì˜¤ë¥¸ìª½ ëê¹Œì§€ ë¶™ìŒ */
        }

        #downloadBtn {
            display: block;
            padding: 12px 25px;
            font-size: 18px;
            font-weight: bold;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            transition: background-color 0.2s ease-in-out;
        }
        #downloadBtn:hover {
            background-color: #0056b3;
        }

        .toast-message {
            position: fixed; /* ë·°í¬íŠ¸ ë‚´ ê³ ì • */
            bottom: 30px; /* í™”ë©´ ì•„ë˜ì—ì„œ 30px ìœ„ë¡œ */
            left: 50%; /* ìˆ˜í‰ ì¤‘ì•™ */
            transform: translateX(-50%); /* ì •í™•íˆ ì¤‘ì•™ ì •ë ¬ */
            padding: 12px 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 8px;
            z-index: 10000; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
            font-size: 14px;
            opacity: 0; /* ì´ˆê¸°ì—ëŠ” íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
            transition: opacity 0.3s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ */
        }

        .toast-message.show {
            opacity: 0.95;
        }
    </style>
</head>
<body>

<div class="download-wrapper ui-control">
    <button id="downloadBtn">ğŸ“¥ HTML ë‹¤ìš´ë¡œë“œ</button>
</div>

<script>
    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
    document.getElementById('downloadBtn').addEventListener('click', () => {
        // 1) í˜„ì¬ ë¬¸ì„œì˜ ì „ì²´ êµ¬ì¡°(html íƒœê·¸ í¬í•¨)ë¥¼ ë³µì œ(Clone)í•©ë‹ˆë‹¤.
        const clone = document.documentElement.cloneNode(true);

        // 2) ë³µì œëœ ë¬¸ì„œì—ì„œ ë¶ˆí•„ìš”í•œ UI ìš”ì†Œ(ë²„íŠ¼, íƒ€ì´í‹€)ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
        const uiControls = clone.querySelectorAll('.ui-control');
        uiControls.forEach(el => el.remove());

        // 3) ë³µì œëœ ë¬¸ì„œì—ì„œ ìŠ¤í¬ë¦½íŠ¸(WebSocket ì—°ê²° ë¡œì§)ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
        const scripts = clone.querySelectorAll('script');
        scripts.forEach(el => el.remove());

        // 4) HTML ë¬¸ìì—´ë¡œ ë³€í™˜
        const htmlContent = `<!DOCTYPE html>\n` + clone.outerHTML;

        // 5) ê°€ìƒì˜ ë§í¬ë¥¼ ë§Œë“¤ì–´ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
        const blob = new Blob([htmlContent], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'my_website_result.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');

    if (!roomId) {
        // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì‘ê²Œ í‘œì‹œ (í—¤ë”© ìŠ¤íƒ€ì¼ ì œì™¸)
        const errorMsg = document.createElement('div');
        errorMsg.innerText = "Error: ìº”ë²„ìŠ¤ ID(Room ID)ê°€ URLì— ì—†ìŠµë‹ˆë‹¤.";
        errorMsg.style.color = "red";
        errorMsg.style.padding = "20px";
        document.body.appendChild(errorMsg);

    } else {
        // room IDê°€ í¬í•¨ëœ ì£¼ì†Œë¡œ ì›¹ì†Œì¼“ ì—°ê²°ì„ ìˆ˜í–‰
        // (í„°ë„ë§ í™˜ê²½ ê³ ë ¤í•˜ì—¬ í”„ë¡œí† ì½œ/í˜¸ìŠ¤íŠ¸ ë™ì  ê°ì§€)
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const ws = new WebSocket(`${protocol}//${host}/ws/${roomId}`);

        function aarrggbbToRgba(hex) {
            hex = hex.replace('#', '');
            if (hex.length === 6) hex = 'FF' + hex;
            if (hex.length !== 8) {
                console.warn("ì˜ëª»ëœ AARRGGBB í˜•ì‹:", hex);
                return null;
            }
            const a = parseInt(hex.substring(0, 2), 16) / 255.0;
            const r = parseInt(hex.substring(2, 4), 16);
            const g = parseInt(hex.substring(4, 6), 16);
            const b = parseInt(hex.substring(6, 8), 16);
            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }

        function getCorrectedWebImageUrl(originalUrl) {
            const currentHost = window.location.protocol + "//" + window.location.host;
            return originalUrl.replace("http://localhost:8080", currentHost);
        }

        function applyStylesAndText(el, command) {
            el.style.position = 'absolute';
            el.style.top = (command.offsetY || 10) + 'px';
            el.style.left = (command.offsetX || 10) + 'px';
            el.style.width = (command.width || 200) + 'px';
            el.style.height = (command.height || 150) + 'px';

            if (command.layer !== undefined && command.layer !== null) {
                el.style.zIndex = Math.round(command.layer);
            }

            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.justifyContent = 'center';

            if (command.style) {
                const style = command.style;
                if (style.backgroundColor) el.style.backgroundColor = aarrggbbToRgba(style.backgroundColor);
                if (style.fontColor) el.style.color = aarrggbbToRgba(style.fontColor);
                if (style.fontSize) el.style.fontSize = style.fontSize + 'px';
                if (style.fontWeight) el.style.fontWeight = style.fontWeight;
                if (style.fontFamily) el.style.fontFamily = style.fontFamily;

                if (style.borderColor) {
                    el.style.borderColor = aarrggbbToRgba(style.borderColor);
                    el.style.borderWidth = '1px';
                    el.style.borderStyle = 'solid';
                }

                if (command.type !== "Image" && style.borderRadius) {
                    el.style.borderRadius = style.borderRadius + 'px';
                }
            }

            if (command.text !== undefined && command.text !== null) {
                if (el.tagName === "INPUT") {
                    el.placeholder = command.text;
                    el.value = "";
                } else {
                    el.innerText = command.text; // ë‚˜ë¨¸ì§€ëŠ” innerText ì‚¬ìš©
                }
            }

            // ì´ë¯¸ì§€ ì²˜ë¦¬
            if (command.type === "Image" && command.imageUrl) {
                const imageUrl = getCorrectedWebImageUrl(command.imageUrl);
                el.innerHTML = '';
                const img = document.createElement('img');
                img.src = imageUrl;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = (command.style?.borderRadius || 0) + 'px';
                el.appendChild(img);
            }

            // ì´ë²¤íŠ¸ ì²˜ë¦¬ (actions ë¦¬ìŠ¤íŠ¸ ë°˜ë³µ)
            // ê¸°ì¡´ì˜ command.onClickAction ëŒ€ì‹  command.actionsë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
            if (command.actions && command.actions.length > 0) {
                el.style.cursor = "pointer"; // í´ë¦­ ê°€ëŠ¥ í‘œì‹œ
                el.onclick = function() {
                    command.actions.forEach(action => {
                        executeComponentAction(action);
                    });
                };
            } else {
                el.onclick = null;
                el.style.cursor = "default";
            }
        }

        ws.onopen = () => {
            console.log(`ì„œë²„ì™€ WebSocket ì—°ê²°ë¨. (Room: ${roomId})`);
        };

        function createComponentElement(command) {
            let el;
            if (command.type === "Text") el = document.createElement("p");
            else if (command.type === "Button") el = document.createElement("button");
            else if (command.type === "InputField") {
                el = document.createElement("input");
                el.type = "text";
                el.placeholder = "ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”";
                // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” (ì…ë ¥ì°½ì²˜ëŸ¼ ë³´ì´ê²Œ)
                el.style.border = "1px solid #ccc";
                el.style.padding = "5px";
                el.style.boxSizing = "border-box";
            }
            else el = document.createElement("div");
            el.id = command.id;
            return el;
        }

        ws.onmessage = (event) => {
            console.log("ì„œë²„ ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
            let commands = JSON.parse(event.data);

            if (Array.isArray(commands)) {
                commands.forEach(command => {
                    const existingEl = document.getElementById(command.id);
                    if (existingEl) existingEl.remove();

                    let el = createComponentElement(command);
                    applyStylesAndText(el, command);
                    document.body.appendChild(el);
                });
            } else {
                const command = commands;
                if (command.action === "Create" || command.action === "Update") {
                    let elToUpdate = document.getElementById(command.id);
                    if (elToUpdate) {
                        applyStylesAndText(elToUpdate, command);
                    } else {
                        elToUpdate = createComponentElement(command);
                        applyStylesAndText(elToUpdate, command);
                        document.body.appendChild(elToUpdate);
                    }
                } else if (command.action === "Delete") {
                    const elToRemove = document.getElementById(command.id);
                    if (elToRemove) elToRemove.remove();
                }
            }
        };
    }

    function executeComponentAction(action) {
        if (!action || !action.type) return;

        // íƒ€ê²Ÿ ìš”ì†Œ ì°¾ê¸° (targetIdê°€ ìˆìœ¼ë©´ ì°¾ê³ , ì—†ìœ¼ë©´ null)
        let targetEl = null;
        if (action.targetId) {
            targetEl = document.getElementById(action.targetId);
        }

        switch (action.type) {
            case "SHOW_TOAST":
                displayToast(action.value || "ì•Œë¦¼", 3000);
                break;

            case "OPEN_LINK":
            case "REDIRECT_URL":
                if (action.value) window.location.href = action.value;
                break;

            // í…ìŠ¤íŠ¸ ë³€ê²½ ë¡œì§
            case "SET_TEXT":
                if (targetEl) {
                    // íƒ€ê²Ÿì´ Inputì´ë©´ valueë¥¼, ì•„ë‹ˆë©´ innerTextë¥¼ ë³€ê²½
                    if (targetEl.tagName === "INPUT") {
                        targetEl.value = action.value;
                    } else {
                        targetEl.innerText = action.value;
                    }
                } else {
                    console.warn("íƒ€ê²Ÿ ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", action.targetId);
                }
                break;
            default:
                console.error(`ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ íƒ€ì…: ${action.type}`);
        }
    }

    function displayToast(message, durationInMs = 3000) {
        const toastEl = document.createElement('div');
        toastEl.className = 'toast-message';
        toastEl.textContent = message;
        document.body.appendChild(toastEl);
        setTimeout(() => { toastEl.classList.add('show'); }, 10);
        setTimeout(() => {
            toastEl.classList.remove('show');
            setTimeout(() => { toastEl.remove(); }, 300);
        }, durationInMs);
    }
</script>
</body>
</html>