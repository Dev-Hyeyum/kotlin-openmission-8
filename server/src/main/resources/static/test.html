<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ktor SDUI ìŠ¤í¬ë¦°</title>
    <style>
        /* 5000px x 5000px í¬ê¸°ì˜ ê³ ì •ëœ ìº”ë²„ìŠ¤ */
        body {
            width: 5000px;
            height: 5000px;
            margin: 0;
            padding: 0;
            position: relative; /* ìì‹ ìš”ì†Œ(absolute)ì˜ ê¸°ì¤€ì  */
        }

        .ui-control {
            position: fixed; // ìŠ¤í¬ë¡¤ì— ì˜í–¥ì„ ë°›ì§€ ì•ŠìŒ
            z-index: 9999;
        }

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼
        #downloadBtn {
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #3DDC84;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #downloadBtn:hover {
            background-color: #32b36b;
        }

        p, button {
            margin: 0;
        }

        .toast-message {
            position: fixed; /* ë·°í¬íŠ¸ ë‚´ ê³ ì • */
            bottom: 30px; /* í™”ë©´ ì•„ë˜ì—ì„œ 30px ìœ„ë¡œ */
            left: 50%; /* ìˆ˜í‰ ì¤‘ì•™ */
            transform: translateX(-50%); /* ì •í™•íˆ ì¤‘ì•™ ì •ë ¬ */
            padding: 12px 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 8px;
            z-index: 10000; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
            font-size: 14px;
            opacity: 0; /* ì´ˆê¸°ì—ëŠ” íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
            transition: opacity 0.3s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ */
        }

        .toast-message.show {
            opacity: 0.95; /* ë‚˜íƒ€ë‚  ë•Œ ë¶ˆíˆ¬ëª…í•˜ê²Œ */
        }
    </style>
</head>
<body>

<button id="downloadBtn" class="ui-control">ğŸ“¥ HTML ë‹¤ìš´ë¡œë“œ</button>

<script>
    // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
    document.getElementById('downloadBtn').addEventListener('click', () => {
        // 1) í˜„ì¬ ë¬¸ì„œì˜ ì „ì²´ êµ¬ì¡°(html íƒœê·¸ í¬í•¨)ë¥¼ ë³µì œ(Clone)í•©ë‹ˆë‹¤.
        const clone = document.documentElement.cloneNode(true);

        // 2) ë³µì œëœ ë¬¸ì„œì—ì„œ ë¶ˆí•„ìš”í•œ UI ìš”ì†Œ(ë²„íŠ¼, íƒ€ì´í‹€)ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
        const uiControls = clone.querySelectorAll('.ui-control');
        uiControls.forEach(el => el.remove());

        // 3) ë³µì œëœ ë¬¸ì„œì—ì„œ ìŠ¤í¬ë¦½íŠ¸(WebSocket ì—°ê²° ë¡œì§)ë¥¼
        const scripts = clone.querySelectorAll('script');
        scripts.forEach(el => el.remove());

        // 4) HTML ë¬¸ìì—´ë¡œ ë³€í™˜
        const htmlContent = `<!DOCTYPE html>\n` + clone.outerHTML;

        // 5) ê°€ìƒì˜ ë§í¬ë¥¼ ë§Œë“¤ì–´ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
        const blob = new Blob([htmlContent], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'my_website_result.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');

    if (!roomId) {
        document.body.innerHTML = "<h1>Error: ìº”ë²„ìŠ¤ ID(Room ID)ê°€ URLì— ì—†ìŠµë‹ˆë‹¤.</h1>";

    } else {
        // room IDê°€ í¬í•¨ëœ ì£¼ì†Œë¡œ ì›¹ì†Œì¼“ ì—°ê²°ì„ ìˆ˜í–‰
        const ws = new WebSocket(`ws://localhost:8080/ws/${roomId}`);

        function aarrggbbToRgba(hex) {
            hex = hex.replace('#', ''); // '#' ì œê±°

            // 6ìë¦¬ (RRGGBB)ê°€ ì˜¤ë©´, íˆ¬ëª…ë„ 100% (FF)ë¥¼ ë§¨ ì•ì— ì¶”ê°€
            if (hex.length === 6) {
                hex = 'FF' + hex;
            }

            // 8ìë¦¬ (AARRGGBB)ê°€ ì•„ë‹ˆë©´ ì˜¤ë¥˜
            if (hex.length !== 8) {
                console.warn("ì˜ëª»ëœ AARRGGBB í˜•ì‹:", hex);
                return null; // (ê¸°ë³¸ê°’)
            }

            const a = parseInt(hex.substring(0, 2), 16) / 255.0; // Alpha (íˆ¬ëª…ë„)
            const r = parseInt(hex.substring(2, 4), 16); // Red
            const g = parseInt(hex.substring(4, 6), 16); // Green
            const b = parseInt(hex.substring(6, 8), 16); // Blue

            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }


        function applyStylesAndText(el, command) {
            el.style.position = 'absolute';
            el.style.top = (command.offsetY || 10) + 'px';
            el.style.left = (command.offsetX || 10) + 'px';
            el.style.width = (command.width || 200) + 'px';
            el.style.height = (command.height || 150) + 'px';

            el.style.display = 'flex';
            el.style.alignItems = 'center'; // ìˆ˜ì§ ì¤‘ì•™
            el.style.justifyContent = 'center'; // ìˆ˜í‰ ì¤‘ì•™

            if (command.text) {
                el.innerText = command.text;
            }

            if (command.style) {
                const style = command.style;
                if (style.backgroundColor) el.style.backgroundColor = aarrggbbToRgba(style.backgroundColor);
                if (style.fontColor) el.style.color = aarrggbbToRgba(style.fontColor);
                if (style.fontSize) el.style.fontSize = style.fontSize + 'px';
                if (style.fontWeight) el.style.fontWeight = style.fontWeight;
                if (style.fontFamily) el.style.fontFamily = style.fontFamily;

                if (style.borderColor) {
                    el.style.borderColor = aarrggbbToRgba(style.borderColor);
                    el.style.borderWidth = '1px';
                    el.style.borderStyle = 'solid';
                }

                if (command.type !== "Image" && style.borderRadius) {
                    el.style.borderRadius = style.borderRadius + 'px';
                }
            }

            if (command.type === "Image" && command.imageUrl) {
                const imageUrl = getCorrectedWebImageUrl(command.imageUrl);

                // 1. ê¸°ì¡´ ìš”ì†Œì˜ ë‚´ìš©ì„ ëª¨ë‘ ì§€ì›ë‹ˆë‹¤.
                el.innerHTML = '';

                // 2. ì´ë¯¸ì§€ë¥¼ ë‹´ì„ HTML ìš”ì†Œ ìƒì„±
                const img = document.createElement('img');
                img.src = imageUrl; // ë³´ì •ëœ URL ì ìš©

                // 3. ì´ë¯¸ì§€ê°€ ë¶€ëª¨ divë¥¼ ê½‰ ì±„ìš°ë„ë¡ ìŠ¤íƒ€ì¼ ì„¤ì •
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover'; // ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ìš°ê¸°
                img.style.borderRadius = (command.style?.borderRadius || 0) + 'px'; // Border Radius ì ìš©

                // 4. ì»´í¬ë„ŒíŠ¸ ìš”ì†Œì— ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ì‚½ì…
                el.appendChild(img);

            } else if (command.type === "Button" && command.onClickAction) {
                el.addEventListener('click', () => {
                    // ì´ì „ì— ì •ì˜í•œ ì´ë²¤íŠ¸ í•´ì„ í•¨ìˆ˜ í˜¸ì¶œ (í† ìŠ¤íŠ¸ ë„ìš°ê¸°)
                    executeComponentAction(command.onClickAction);
                });
            } else if (command.text) {
                // Image íƒ€ì…ì´ ì•„ë‹ ë•Œë§Œ í…ìŠ¤íŠ¸ë¥¼ ë„£ìŠµë‹ˆë‹¤.
                el.innerHTML = command.text; // innerText ëŒ€ì‹  innerHTMLì„ ì‚¬ìš©í•˜ì—¬ ì´ì „ ì½˜í…ì¸  ì œê±° (ì„ íƒ ì‚¬í•­)
            }
        }

        ws.onopen = () => {
            console.log(`ì„œë²„ì™€ WebSocket ì—°ê²°ë¨. (Room: ${roomId})`);
        };

        function createComponentElement(command) {
            let el;
            if (command.type === "Text") el = document.createElement("p");
            else if (command.type === "Button") el = document.createElement("button");
            else el = document.createElement("div");
            el.id = command.id;
            return el;
        }

        ws.onmessage = (event) => {
            console.log("ì„œë²„ ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
            let commands = JSON.parse(event.data);

            if (Array.isArray(commands)) {
                // (ì´ˆê¸° ë°ì´í„° ë¡œë“œ)
                commands.forEach(command => {
                    const existingEl = document.getElementById(command.id);
                    if (existingEl) existingEl.remove();

                    let el = createComponentElement(command);
                    applyStylesAndText(el, command);
                    document.body.appendChild(el);
                });
            } else {
                // ì‹¤ì‹œê°„ ëª…ë ¹ ìˆ˜ì‹ 
                const command = commands;
                if (command.action === "Create" || command.action === "Update") {
                    let elToUpdate = document.getElementById(command.id);
                    if (elToUpdate) {
                        applyStylesAndText(elToUpdate, command);
                    } else {
                        elToUpdate = createComponentElement(command);
                        applyStylesAndText(elToUpdate, command);
                        document.body.appendChild(elToUpdate);
                    }
                } else if (command.action === "Delete") {
                    const elToRemove = document.getElementById(command.id);
                    if (elToRemove) elToRemove.remove();
                }
            }
        };
    }

    function executeComponentAction(action) {
        if (!action || !action.type) return;

        switch (action.type) {
            case "SHOW_TOAST":
                // ìº”ë²„ìŠ¤ì˜ ê³ ì •ëœ ìœ„ì¹˜ì— ì›¹ í† ìŠ¤íŠ¸/ì•Œë¦¼ ì°½ì„ ë„ì›ë‹ˆë‹¤.
                // alert(action.message || "ë²„íŠ¼ì´ í´ë¦­ë˜ì—ˆìŠµë‹ˆë‹¤!"); â¬…ï¸ ì´ ë¶€ë¶„ì„ ì œê±°í•˜ê³  ì•„ë˜ í•¨ìˆ˜ í˜¸ì¶œë¡œ ë³€ê²½
                displayToast(action.message || "ë²„íŠ¼ì´ í´ë¦­ë˜ì—ˆìŠµë‹ˆë‹¤!", 3000);
                break;
            case "REDIRECT_URL":
                if (action.targetUrl) {
                    window.location.href = action.targetUrl;
                }
                break;
            default:
                console.error(`ì•Œ ìˆ˜ ì—†ëŠ” ì´ë²¤íŠ¸ íƒ€ì…: ${action.type}`);
            }
        }

    // âœ¨ [ìƒˆ í•¨ìˆ˜] ì»¤ìŠ¤í…€ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í•¨ìˆ˜
    function displayToast(message, durationInMs = 3000) {
        // 1. í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ ë‹´ì„ ìš”ì†Œ ìƒì„±
        const toastEl = document.createElement('div');
        toastEl.className = 'toast-message';
        toastEl.textContent = message;

        // 2. í™”ë©´ (body)ì— ì¶”ê°€
        document.body.appendChild(toastEl);

        // 3. âœ¨ ë‚˜íƒ€ë‚˜ëŠ” ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì ì‹œ í›„ 'show' í´ë˜ìŠ¤ ì¶”ê°€
        // ì´ë¥¼ í†µí•´ CSSì˜ transition íš¨ê³¼ê°€ ì ìš©ë©ë‹ˆë‹¤.
        setTimeout(() => {
            toastEl.classList.add('show');
        }, 10); // ì•„ì£¼ ì§§ì€ ë”œë ˆì´


        // 4. âœ¨ [í•µì‹¬ í•´ê²°] ì¼ì • ì‹œê°„ì´ ì§€ë‚œ í›„ ìš”ì†Œë¥¼ ì œê±°í•˜ëŠ” íƒ€ì´ë¨¸ ì„¤ì •
        setTimeout(() => {
            // ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ 'show' í´ë˜ìŠ¤ ì œê±°
            toastEl.classList.remove('show');

            // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„ ìš”ì†Œë¥¼ DOMì—ì„œ ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤.
            setTimeout(() => {
                 toastEl.remove();
            }, 300); // CSS transition ì‹œê°„(0.3s)ë§Œí¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.

        }, durationInMs);
    }

    function getCorrectedWebImageUrl(originalUrl) {
        // í˜„ì¬ ì›¹ í˜ì´ì§€ê°€ ì ‘ì†í•œ ì£¼ì†Œì˜ í”„ë¡œí† ì½œê³¼ í˜¸ìŠ¤íŠ¸(IP:Port)ë¥¼ ê°€ì ¸ì˜´
        const currentHost = window.location.protocol + "//" + window.location.host;

        // ì„œë²„ê°€ ë³´ë‚´ì¤€ URLì˜ http://localhost:8080 ë¶€ë¶„ì„ ì‹¤ì œ ì ‘ì† ì£¼ì†Œë¡œ ëŒ€ì²´
        // ì´ëŠ” ì•ˆë“œë¡œì´ë“œì˜ BuildConfig.BASE_URL ì—­í• ì„ í•©ë‹ˆë‹¤.
        return originalUrl.replace("http://localhost:8080", currentHost);
    }
</script>
</body>
</html>