<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ktor SDUI 스크린</title>
    <style>
        /* 5000px x 5000px 크기의 고정된 캔버스 */
        body {
            width: 5000px;
            height: 5000px;
            margin: 0;
            padding: 0;
            position: relative; /* 자식 요소(absolute)의 기준점 */
        }
        h1 {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
<script>
    const ws = new WebSocket("ws://localhost:8080/ws");

     // 엘리먼트(el)에 서버(command)의 스타일을 '번역'하여 적용해주는 헬퍼 함수

    function applyStylesAndText(el, command) {
        // 1. 레이아웃 적용
        el.style.position = 'absolute';
        el.style.top = (command.offsetY || 10) + 'px';
        el.style.left = (command.offsetX || 10) + 'px';
        el.style.width = (command.width || 200) + 'px';
        el.style.height = (command.height || 150) + 'px';
        el.style.border = '1px solid gray';

        // 2. 텍스트 적용
        if (command.text) {
            el.innerText = command.text;
        }

        // 스타일 맵을 CSS코드로 변환하는 로직
        if (command.style) {
            const style = command.style; // { "backgroundColor": "#FF0000", ... }

            // 배경색
            if (style.backgroundColor) {
                el.style.backgroundColor = style.backgroundColor;
            }
            // 글자색
            if (style.color) {
                el.style.color = style.color;
            }
            // 글자 크기
            if (style.fontSize) {
                el.style.fontSize = style.fontSize + 'px'; // 'px' 단위 추가
            }
            // 글자 두께
            if (style.fontWeight) {
                el.style.fontWeight = style.fontWeight;
            }
            // 폰트
            if (style.fontFamily) {
                el.style.fontFamily = style.fontFamily;
            }
        }
    }


    ws.onopen = () => {
        console.log("서버와 WebSocket 연결됨.");
    };

    ws.onmessage = (event) => {
        console.log("서버 메시지 수신:", event.data);

        let commands = JSON.parse(event.data);

        if (Array.isArray(commands)) {
             // 1. 초기 전체 리스트 수신 (List<Component>)
            commands.forEach(command => {
                const existingEl = document.getElementById(command.id);
                if (existingEl) existingEl.remove();

                let el = createComponentElement(command);
                applyStylesAndText(el, command);
                document.body.appendChild(el);
            });
        } else {
             // 2. 단일 명령 수신 (Component)
            const command = commands;

            if (command.action === "Create" || command.action === "Update") {
                let elToUpdate = document.getElementById(command.id);

                if (elToUpdate) {
                    // (Update)
                    applyStylesAndText(elToUpdate, command);
                } else {
                    // (Create)
                    elToUpdate = createComponentElement(command);
                    applyStylesAndText(elToUpdate, command);
                    document.body.appendChild(elToUpdate);
                }

            } else if (command.action === "Delete") {
                const elToRemove = document.getElementById(command.id);
                if (elToRemove) {
                    elToRemove.remove();
                }
            }
        }
    };

    // 헬퍼 함수
    function createComponentElement(command) {
        let el;
        if (command.type === "Text") {
            el = document.createElement("p");
        } else if (command.type === "Button") {
            el = document.createElement("button");
        } else {
            el = document.createElement("div"); // 기본값
        }
        el.id = command.id;
        return el;
    }
</script>
</body>
</html>