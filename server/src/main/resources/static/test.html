<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ktor SDUI 스크린</title>
    <style>
        /* 5000px x 5000px 크기의 고정된 캔버스 */
        body {
            width: 5000px;
            height: 5000px;
            margin: 0;
            padding: 0;
            position: relative; /* 자식 요소(absolute)의 기준점 */
        }
        h1 {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
        }

        p, button {
            margin: 0;
        }
    </style>
</head>
<body>
<script>
    // URL에서 'room' 파라미터(방 ID)를 읽어오는 코드
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');

    if (!roomId) {
        document.body.innerHTML = "<h1>Error: 캔버스 ID(Room ID)가 URL에 없습니다.</h1>";

    } else {
        // room ID가 포함된 주소로 웹소켓 연결을 수행
        const ws = new WebSocket(`ws://localhost:8080/ws/${roomId}`);

        function aarrggbbToRgba(hex) {
            hex = hex.replace('#', ''); // '#' 제거

            // 6자리 (RRGGBB)가 오면, 투명도 100% (FF)를 맨 앞에 추가
            if (hex.length === 6) {
                hex = 'FF' + hex;
            }

            // 8자리 (AARRGGBB)가 아니면 오류
            if (hex.length !== 8) {
                console.warn("잘못된 AARRGGBB 형식:", hex);
                return null; // (기본값)
            }

            const a = parseInt(hex.substring(0, 2), 16) / 255.0; // Alpha (투명도)
            const r = parseInt(hex.substring(2, 4), 16); // Red
            const g = parseInt(hex.substring(4, 6), 16); // Green
            const b = parseInt(hex.substring(6, 8), 16); // Blue

            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }


        function applyStylesAndText(el, command) {
            el.style.position = 'absolute';
            el.style.top = (command.offsetY || 10) + 'px';
            el.style.left = (command.offsetX || 10) + 'px';
            el.style.width = (command.width || 200) + 'px';
            el.style.height = (command.height || 150) + 'px';
            // el.style.border = '1px solid gray';

            if (command.text) {
                el.innerText = command.text;
            }

            if (command.style) {
                const style = command.style;

                //'AARRGGBB'를 'rgba()'로 변환
                if (style.backgroundColor) el.style.backgroundColor = aarrggbbToRgba(style.backgroundColor);
                if (style.fontColor) el.style.color = aarrggbbToRgba(style.fontColor);
                if (style.fontSize) el.style.fontSize = style.fontSize + 'px';
                if (style.fontWeight) el.style.fontWeight = style.fontWeight;
                if (style.fontFamily) el.style.fontFamily = style.fontFamily;

                if (style.borderColor) {
                    el.style.borderColor = aarrggbbToRgba(style.borderColor);
                    el.style.borderWidth = '1px';
                    el.style.borderStyle = 'solid';
        }
            }
        }

        ws.onopen = () => {
            console.log(`서버와 WebSocket 연결됨. (Room: ${roomId})`);
        };

        function createComponentElement(command) {
            let el;
            if (command.type === "Text") el = document.createElement("p");
            else if (command.type === "Button") el = document.createElement("button");
            else el = document.createElement("div");
            el.id = command.id;
            return el;
        }

        ws.onmessage = (event) => {
            console.log("서버 메시지 수신:", event.data);
            let commands = JSON.parse(event.data);

            if (Array.isArray(commands)) {
                // (초기 데이터 로드)
                commands.forEach(command => {
                    const existingEl = document.getElementById(command.id);
                    if (existingEl) existingEl.remove();

                    let el = createComponentElement(command);
                    applyStylesAndText(el, command);
                    document.body.appendChild(el);
                });
            } else {
                // 실시간 명령 수신
                const command = commands;
                if (command.action === "Create" || command.action === "Update") {
                    let elToUpdate = document.getElementById(command.id);
                    if (elToUpdate) {
                        applyStylesAndText(elToUpdate, command);
                    } else {
                        elToUpdate = createComponentElement(command);
                        applyStylesAndText(elToUpdate, command);
                        document.body.appendChild(elToUpdate);
                    }
                } else if (command.action === "Delete") {
                    const elToRemove = document.getElementById(command.id);
                    if (elToRemove) elToRemove.remove();
                }
            }
        };
    }
</script>
</body>
</html>