<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ktor SDUI ìŠ¤í¬ë¦°</title>
    <style>
        /* 5000px x 5000px í¬ê¸°ì˜ ê³ ì •ëœ ìº”ë²„ìŠ¤ */
        body {
            width: 5000px;
            height: 5000px;
            margin: 0;
            padding: 0;
            position: relative; /* ìì‹ ìš”ì†Œ(absolute)ì˜ ê¸°ì¤€ì  */
        }

        .ui-control {
            position: fixed; // ìŠ¤í¬ë¡¤ì— ì˜í–¥ì„ ë°›ì§€ ì•ŠìŒ
            z-index: 9999;
        }

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼
        #downloadBtn {
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #3DDC84;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #downloadBtn:hover {
            background-color: #32b36b;
        }

        p, button {
            margin: 0;
        }
    </style>
</head>
<body>

<button id="downloadBtn" class="ui-control">ğŸ“¥ HTML ë‹¤ìš´ë¡œë“œ</button>

<script>
    // URLì—ì„œ 'room' íŒŒë¼ë¯¸í„°(ë°© ID)ë¥¼ ì½ì–´ì˜¤ëŠ” ì½”ë“œ
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');

    if (!roomId) {
        document.body.innerHTML = "<h1>Error: ìº”ë²„ìŠ¤ ID(Room ID)ê°€ URLì— ì—†ìŠµë‹ˆë‹¤.</h1>";

    } else {
        // room IDê°€ í¬í•¨ëœ ì£¼ì†Œë¡œ ì›¹ì†Œì¼“ ì—°ê²°ì„ ìˆ˜í–‰
        const ws = new WebSocket(`ws://localhost:8080/ws/${roomId}`);

        function aarrggbbToRgba(hex) {
            hex = hex.replace('#', ''); // '#' ì œê±°

            // 6ìë¦¬ (RRGGBB)ê°€ ì˜¤ë©´, íˆ¬ëª…ë„ 100% (FF)ë¥¼ ë§¨ ì•ì— ì¶”ê°€
            if (hex.length === 6) {
                hex = 'FF' + hex;
            }

            // 8ìë¦¬ (AARRGGBB)ê°€ ì•„ë‹ˆë©´ ì˜¤ë¥˜
            if (hex.length !== 8) {
                console.warn("ì˜ëª»ëœ AARRGGBB í˜•ì‹:", hex);
                return null; // (ê¸°ë³¸ê°’)
            }

            const a = parseInt(hex.substring(0, 2), 16) / 255.0; // Alpha (íˆ¬ëª…ë„)
            const r = parseInt(hex.substring(2, 4), 16); // Red
            const g = parseInt(hex.substring(4, 6), 16); // Green
            const b = parseInt(hex.substring(6, 8), 16); // Blue

            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }


        function applyStylesAndText(el, command) {
            el.style.position = 'absolute';
            el.style.top = (command.offsetY || 10) + 'px';
            el.style.left = (command.offsetX || 10) + 'px';
            el.style.width = (command.width || 200) + 'px';
            el.style.height = (command.height || 150) + 'px';

            el.style.display = 'flex';
            el.style.alignItems = 'center'; // ìˆ˜ì§ ì¤‘ì•™
            el.style.justifyContent = 'center'; // ìˆ˜í‰ ì¤‘ì•™

            if (command.text) {
                el.innerText = command.text;
            }

            if (command.style) {
                const style = command.style;
                if (style.backgroundColor) el.style.backgroundColor = aarrggbbToRgba(style.backgroundColor);
                if (style.fontColor) el.style.color = aarrggbbToRgba(style.fontColor);
                if (style.fontSize) el.style.fontSize = style.fontSize + 'px';
                if (style.fontWeight) el.style.fontWeight = style.fontWeight;
                if (style.fontFamily) el.style.fontFamily = style.fontFamily;

                if (style.borderColor) {
                    el.style.borderColor = aarrggbbToRgba(style.borderColor);
                    el.style.borderWidth = '1px';
                    el.style.borderStyle = 'solid';
                }
                if (style.borderRadius) {
                    el.style.borderRadius = style.borderRadius + 'px';
                }
            }
        }

        ws.onopen = () => {
            console.log(`ì„œë²„ì™€ WebSocket ì—°ê²°ë¨. (Room: ${roomId})`);
        };

        function createComponentElement(command) {
            let el;
            if (command.type === "Text") el = document.createElement("p");
            else if (command.type === "Button") el = document.createElement("button");
            else el = document.createElement("div");
            el.id = command.id;
            return el;
        }

        ws.onmessage = (event) => {
            console.log("ì„œë²„ ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
            let commands = JSON.parse(event.data);

            if (Array.isArray(commands)) {
                // (ì´ˆê¸° ë°ì´í„° ë¡œë“œ)
                commands.forEach(command => {
                    const existingEl = document.getElementById(command.id);
                    if (existingEl) existingEl.remove();

                    let el = createComponentElement(command);
                    applyStylesAndText(el, command);
                    document.body.appendChild(el);
                });
            } else {
                // ì‹¤ì‹œê°„ ëª…ë ¹ ìˆ˜ì‹ 
                const command = commands;
                if (command.action === "Create" || command.action === "Update") {
                    let elToUpdate = document.getElementById(command.id);
                    if (elToUpdate) {
                        applyStylesAndText(elToUpdate, command);
                    } else {
                        elToUpdate = createComponentElement(command);
                        applyStylesAndText(elToUpdate, command);
                        document.body.appendChild(elToUpdate);
                    }
                } else if (command.action === "Delete") {
                    const elToRemove = document.getElementById(command.id);
                    if (elToRemove) elToRemove.remove();
                }
            }
        };
    }
</script>
</body>
</html>